<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hazte Socio - CD Bustarviejo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(180deg, #1a2744 0%, #1e3a5f 40%, #1a2744 100%);
            color: #e2e8f0;
        }
        .container { max-width: 700px; margin: 0 auto; padding: 20px 16px; }

        /* Header */
        .header { text-align: center; padding: 40px 0 20px; }
        .logo {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            object-fit: cover;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .title { font-size: 28px; font-weight: 800; margin-top: 16px; color: #fbbf24; }
        .subtitle { color: #94a3b8; font-size: 15px; margin-top: 6px; }

        /* Benefits card */
        .benefits {
            background: linear-gradient(135deg, rgba(220,252,231,0.95), rgba(209,250,229,0.90));
            border-radius: 16px; padding: 24px; margin: 24px 0; color: #1e293b;
        }
        .benefits h3 { color: #14532d; font-size: 20px; margin-bottom: 16px; }
        .benefits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 500px) { .benefits-grid { grid-template-columns: 1fr; } }
        .benefit-item {
            background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px;
            border: 1px solid rgba(34,197,94,0.2);
        }
        .benefit-item h4 { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .benefit-item p { font-size: 13px; color: #475569; }

        /* Share box */
        .share-box {
            background: linear-gradient(135deg, #ec4899, #a855f7);
            border-radius: 16px; padding: 24px; margin: 24px 0; text-align: center; color: #fff;
        }
        .share-box h3 { font-size: 18px; margin-bottom: 8px; }
        .share-box p { font-size: 14px; opacity: 0.9; margin-bottom: 16px; }
        .share-btn {
            background: #fff; color: #16a34a; border: none; border-radius: 30px;
            padding: 12px 28px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;
        }
        .share-btn:hover { transform: scale(1.05); }

        /* Form card */
        .form-card { background: #fff; border-radius: 16px; overflow: hidden; margin: 24px 0; color: #1e293b; }
        .form-header {
            background: linear-gradient(90deg, #16a34a, #059669);
            padding: 16px 24px; color: #fff;
        }
        .form-header h2 { font-size: 18px; font-weight: 700; }
        .form-body { padding: 24px; }

        .personal-link-warning {
            background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px;
            padding: 14px; margin-bottom: 20px; font-size: 13px; color: #92400e;
        }
        .referral-banner {
            background: linear-gradient(90deg, #faf5ff, #fce7f3);
            border: 2px solid #e9d5ff; border-radius: 12px;
            padding: 14px; margin-bottom: 20px; font-size: 14px; color: #581c87;
            display: none;
        }

        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #334155; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

        input[type="text"], input[type="email"], input[type="tel"], input[type="date"] {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 16px; outline: none; transition: border-color 0.2s;
        }
        input:focus { border-color: #16a34a; }

        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-option {
            display: flex; align-items: center; gap: 12px; padding: 14px;
            border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .radio-option:hover, .radio-option.selected { border-color: #16a34a; background: #f0fdf4; }
        .radio-option input[type="radio"] { accent-color: #16a34a; width: 18px; height: 18px; flex-shrink: 0; }
        .radio-content h4 { font-size: 14px; font-weight: 700; }
        .radio-content p { font-size: 12px; color: #64748b; }

        /* Payment box */
        .payment-box {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid #86efac; border-radius: 12px; padding: 20px; margin-top: 20px;
        }
        .payment-box h3 { color: #14532d; margin-bottom: 12px; }
        .payment-type-option {
            display: flex; align-items: flex-start; gap: 12px; padding: 16px;
            background: #fff; border: 2px solid #e2e8f0; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
        }
        .payment-type-option:hover, .payment-type-option.selected { border-color: #16a34a; background: #f0fdf4; }
        .payment-type-option input[type="radio"] { accent-color: #16a34a; width: 18px; height: 18px; margin-top: 3px; flex-shrink: 0; }
        .payment-type-option .pto-title { font-weight: 700; font-size: 15px; }
        .payment-type-option .pto-desc { font-size: 12px; color: #64748b; margin-top: 2px; }
        .payment-type-option .pto-price { font-size: 20px; font-weight: 800; color: #16a34a; }
        .payment-type-option .pto-badge {
            display: inline-block; background: #fbbf24; color: #78350f; font-size: 10px;
            font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 8px;
        }

        .privacy-notice {
            margin-top: 20px; padding: 14px; background: #f8fafc;
            border-radius: 10px; font-size: 12px; color: #64748b; line-height: 1.5;
        }
        .privacy-notice a { color: #16a34a; }

        .submit-btn {
            width: 100%; padding: 18px; border: none; border-radius: 14px;
            font-size: 18px; font-weight: 700; color: #fff; cursor: pointer;
            background: linear-gradient(90deg, #16a34a, #059669);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: transform 0.2s; margin-top: 20px;
        }
        .submit-btn:hover { transform: translateY(-2px); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .error-message {
            background: #fef2f2; border: 2px solid #fecaca; color: #991b1b;
            padding: 12px; border-radius: 10px; font-size: 14px; margin-bottom: 16px; display: none;
        }

        .success-message {
            text-align: center; padding: 40px 20px; display: none;
        }
        .success-message h2 { color: #14532d; font-size: 24px; margin-bottom: 10px; }
        .success-message p { color: #475569; font-size: 15px; }
        .success-message .stripe-redirect-btn {
            display: inline-block; margin-top: 20px; padding: 14px 32px;
            background: linear-gradient(90deg, #16a34a, #059669); color: #fff;
            border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 16px;
        }

        /* Footer */
        .footer { text-align: center; padding: 30px 0; font-size: 13px; color: #64748b; }
        .footer a { color: #94a3b8; }

        /* Spinner */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Copy toast */
        .copy-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #16a34a; color: #fff; padding: 12px 24px; border-radius: 30px;
            font-weight: 700; font-size: 14px; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .copy-toast.show { opacity: 1; }

        /* Stripe badge */
        .stripe-badge {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            margin-top: 12px; font-size: 12px; color: #64748b;
        }
        .stripe-badge img { height: 20px; }
    </style>
</head>
<body>

<div class="copy-toast" id="copyToast">‚úÖ ¬°Copiado!</div>

<div class="container">
    <!-- Header -->
    <div class="header">
        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6911b8e453ca3ac01fb134d6/e3f0a8e26_logo_cd_bustarviejo_mediano.jpg" alt="CD Bustarviejo" class="logo">
        <h1 class="title">üéâ ¬°Hazte Socio del CD Bustarviejo!</h1>
        <p class="subtitle">Forma parte de nuestra gran familia deportiva</p>
    </div>

    <!-- Benefits -->
    <div class="benefits">
        <h3>‚≠ê ¬øPor qu√© ser socio?</h3>
        <div class="benefits-grid">
            <div class="benefit-item">
                <h4>üíö Apoyo esencial al club</h4>
                <p>Tu aportaci√≥n es vital para el desarrollo de nuestros j√≥venes deportistas</p>
            </div>
            <div class="benefit-item">
                <h4>üë• Fuerza para la comunidad</h4>
                <p>√önete a la gran familia del club y vive la pasi√≥n por el deporte</p>
            </div>
            <div class="benefit-item">
                <h4>üéâ Eventos inolvidables</h4>
                <p>Participa en las actividades del club y comparte experiencias √∫nicas</p>
            </div>
            <div class="benefit-item">
                <h4>‚ú® Compromiso con el deporte base</h4>
                <p>Contribuye al crecimiento y formaci√≥n de nuestros deportistas</p>
            </div>
        </div>
    </div>

    <!-- Share Box -->
    <div class="share-box">
        <h3>ü§ù ¬øConoces a m√°s personas que quieran apoyar al club?</h3>
        <p>¬°Comparte este enlace con familiares y amigos!</p>
        <button class="share-btn" onclick="shareWhatsApp()">üí¨ Compartir por WhatsApp</button>
    </div>

    <!-- Form -->
    <div class="form-card">
        <div class="form-header">
            <h2>üë• Formulario de Inscripci√≥n como Socio</h2>
        </div>
        <div class="form-body">
            <div class="error-message" id="errorMessage"></div>

            <div class="personal-link-warning" id="personalLinkWarning">
                <p>‚ö†Ô∏è <strong>Aviso importante:</strong> Si alguien te ha reenviado este enlace (no te lo envi√≥ directamente la persona que te invit√≥), el programa de premios por referidos <strong>no aplicar√°</strong>. Cada enlace es personal e intransferible.</p>
            </div>

            <div class="referral-banner" id="referralBanner">
                <p>üéÅ <strong>¬°Te han invitado!</strong> Al registrarte, quien te invit√≥ recibir√° un premio.</p>
            </div>

            <div class="form-content" id="formContent">
                <form id="memberForm" autocomplete="on" onsubmit="handleSubmit(event)">

                    <!-- Tipo inscripci√≥n -->
                    <div class="form-group">
                        <label>Tipo de Inscripci√≥n *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectRadio(this)">
                                <input type="radio" name="tipo_inscripcion" value="Nueva Inscripci√≥n" checked>
                                <div class="radio-content">
                                    <h4>üÜï Nueva Inscripci√≥n</h4>
                                    <p>Primera vez como socio del club</p>
                                </div>
                            </label>
                            <label class="radio-option" onclick="selectRadio(this)">
                                <input type="radio" name="tipo_inscripcion" value="Renovaci√≥n">
                                <div class="radio-content">
                                    <h4>üîÑ Renovaci√≥n</h4>
                                    <p>Ya fui socio en temporadas anteriores</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Datos personales -->
                    <h3 style="margin: 25px 0 15px; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">Datos del nuevo socio</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre_completo">Nombre y Apellidos *</label>
                            <input type="text" id="nombre_completo" name="nombre_completo" autocomplete="name" placeholder="Ej: Juan Garc√≠a L√≥pez" required>
                        </div>
                        <div class="form-group">
                            <label for="dni">DNI *</label>
                            <input type="text" id="dni" name="dni" autocomplete="off" placeholder="12345678A" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="telefono">Tel√©fono M√≥vil *</label>
                            <input type="tel" id="telefono" name="telefono" autocomplete="tel" placeholder="600123456" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Correo Electr√≥nico *</label>
                            <input type="email" id="email" name="email" autocomplete="email" placeholder="correo@ejemplo.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Direcci√≥n Completa *</label>
                        <input type="text" id="direccion" name="direccion" autocomplete="street-address" placeholder="Calle, n√∫mero, piso..." required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="municipio">Municipio *</label>
                            <input type="text" id="municipio" name="municipio" autocomplete="address-level2" placeholder="Bustarviejo" required>
                        </div>
                        <div class="form-group">
                            <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="date" id="fecha_nacimiento" name="fecha_nacimiento">
                        </div>
                    </div>

                    <!-- Pago con Stripe -->
                    <div class="payment-box">
                        <h3>üí≥ Pago: 25‚Ç¨ /temporada</h3>
                        <p style="font-size: 13px; color: #166534; margin-bottom: 16px;">Elige c√≥mo prefieres pagar. El pago se realiza de forma segura a trav√©s de Stripe.</p>

                        <div class="payment-type-option selected" onclick="selectPayment(this, 'unico')">
                            <input type="radio" name="tipo_pago" value="unico" checked>
                            <div style="flex:1;">
                                <div class="pto-title">üí≥ Pago √önico</div>
                                <div class="pto-desc">Un solo pago por tarjeta para esta temporada</div>
                            </div>
                            <div class="pto-price">25‚Ç¨</div>
                        </div>

                        <div class="payment-type-option" onclick="selectPayment(this, 'suscripcion')">
                            <input type="radio" name="tipo_pago" value="suscripcion">
                            <div style="flex:1;">
                                <div class="pto-title">üîÑ Suscripci√≥n Anual <span class="pto-badge">RECOMENDADO</span></div>
                                <div class="pto-desc">Se renueva autom√°ticamente cada a√±o. Puedes cancelar en cualquier momento.</div>
                            </div>
                            <div class="pto-price">25‚Ç¨<span style="font-size:12px;font-weight:400;">/a√±o</span></div>
                        </div>

                        <div class="stripe-badge">
                            üîí Pago seguro con Stripe
                        </div>
                    </div>

                    <!-- Privacy -->
                    <div class="privacy-notice">
                        <p>üîí <strong>Protecci√≥n de Datos (RGPD):</strong> Al enviar este formulario, consientes el tratamiento de tus datos personales por el CD Bustarviejo para la gesti√≥n de tu membres√≠a como socio del club. Tus datos ser√°n tratados de forma confidencial y no ser√°n cedidos a terceros sin tu consentimiento. Puedes ejercer tus derechos enviando un email a <a href__="mailto:cdbustarviejo@gmail.com">cdbustarviejo@gmail.com</a>.</p>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="submit-btn" id="submitBtn">
                        üéâ Registrarme y Pagar con Tarjeta
                    </button>
                </form>
            </div>

            <!-- Success -->
            <div class="success-message" id="successMessage">
                <div style="font-size: 5rem; margin-bottom: 20px;">üéâ</div>
                <h2>¬°Redirigiendo al pago!</h2>
                <p>Ser√°s redirigido a la pasarela de pago segura de Stripe.</p>
                <p style="margin-top: 12px; font-size: 13px; color: #94a3b8;">Si no se redirige autom√°ticamente:</p>
                <a href__="#" class="stripe-redirect-btn" id="stripeLink">Ir a pagar ‚Üí</a>
            </div>

            <!-- Paid OK -->
            <div class="success-message" id="paidMessage">
                <div style="font-size: 5rem; margin-bottom: 20px;">‚úÖ</div>
                <h2>¬°Bienvenido/a a la familia!</h2>
                <p>Tu pago se ha completado correctamente.</p>
                <p style="margin-top: 15px;">Recibir√°s tu <strong>carnet virtual</strong> por email en breve.</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>üìß <a href__="mailto:cdbustarviejo@gmail.com">cdbustarviejo@gmail.com</a></p>
        <p style="margin-top:4px;">üìç Bustarviejo, Madrid</p>
        <p style="margin-top: 12px; font-size: 11px;">¬© CD Bustarviejo - Todos los derechos reservados</p>
    </div>
</div>

<script>
    const API_URL = 'https://base44.app/api/apps/6992c6be619d2da592897991/functions/publicMemberCheckout';
    const THIS_PAGE = window.location.href.split('?')[0];

    // Check referral param
    const params = new URLSearchParams(window.location.search);
    const referidoPor = params.get('ref') || params.get('referido') || '';
    if (referidoPor) {
        document.getElementById('referralBanner').style.display = 'block';
        document.getElementById('personalLinkWarning').style.display = 'none';
    }

    // Check paid OK
    if (params.get('paid') === 'ok') {
        document.getElementById('formContent').style.display = 'none';
        document.getElementById('personalLinkWarning').style.display = 'none';
        document.getElementById('paidMessage').style.display = 'block';
    }

    // Check canceled
    if (params.get('canceled')) {
        showError('El pago fue cancelado. Puedes intentarlo de nuevo.');
    }

    function selectRadio(el) {
        el.closest('.radio-group').querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        el.querySelector('input[type="radio"]').checked = true;
    }

    function selectPayment(el, value) {
        document.querySelectorAll('.payment-type-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        el.querySelector('input[type="radio"]').checked = true;
    }

    function showError(msg) {
        const el = document.getElementById('errorMessage');
        el.textContent = msg;
        el.style.display = 'block';
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function shareWhatsApp() {
        const msg = '¬°Hazte socio del CD Bustarviejo! ‚öΩüèÄ\n\nPor solo 25‚Ç¨/temporada ayudas a los j√≥venes deportistas del club.\n\nüëâ ' + THIS_PAGE;
        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const errEl = document.getElementById('errorMessage');
        errEl.style.display = 'none';

        const nombre = document.getElementById('nombre_completo').value.trim();
        const dni = document.getElementById('dni').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const email = document.getElementById('email').value.trim();
        const direccion = document.getElementById('direccion').value.trim();
        const municipio = document.getElementById('municipio').value.trim();
        const fecha_nacimiento = document.getElementById('fecha_nacimiento').value;
        const tipo_pago = document.querySelector('[name="tipo_pago"]:checked').value;

        if (!nombre || !dni || !telefono || !email || !direccion || !municipio) {
            showError('Por favor, rellena todos los campos obligatorios (*)');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Procesando...';

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre_completo: nombre,
                    dni,
                    telefono,
                    email,
                    direccion,
                    municipio,
                    fecha_nacimiento,
                    tipo_pago,
                    referido_por: referidoPor,
                    es_segundo_progenitor: false,
                    success_url: THIS_PAGE + '?paid=ok',
                    cancel_url: THIS_PAGE + '?canceled=true'
                })
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.error || 'Error en el servidor');

            if (data.url) {
                document.getElementById('formContent').style.display = 'none';
                document.getElementById('personalLinkWarning').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('stripeLink').href = data.url;
                document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => { window.location.href = data.url; }, 1500);
            } else {
                throw new Error('No se recibi√≥ enlace de pago');
            }
        } catch (err) {
            showError(err.message || 'Error al procesar. Int√©ntalo de nuevo.');
            btn.disabled = false;
            btn.innerHTML = 'üéâ Registrarme y Pagar con Tarjeta';
        }
    }
</script>

</body>
</html>
